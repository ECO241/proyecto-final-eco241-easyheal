import '../Components/formula.js';

const displayFormulas = async () => {
  const formulaList = document.getElementById('formula-list');
  formulaList.innerHTML = '';

  try {
    const response = await fetch('http://localhost:3000/formulas/paciente/288e1278-a373-4066-977c-517aba1dc005');
    const result = await response.json();

    if (result.success) {
      // Ordenar los datos por fecha de creación en orden descendente
      const formulas = result.data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      // Seleccionar solo la fórmula más reciente (el primer elemento del arreglo)
      const formulaMasReciente = formulas[0];

      // Crear un elemento mi-formula para la fórmula más reciente
      const formulaElement = document.createElement('mi-formula');

      // Configurar los atributos paciente_id y medicamentos del elemento mi-formula
          formulaElement.setAttribute('qr_code', formulaMasReciente.qr_code);
      formulaElement.setAttribute('paciente_id', formulaMasReciente.paciente_id);
      formulaElement.setAttribute('medicamentos', JSON.stringify(formulaMasReciente.medicamentos));

      // Crear un elemento de imagen para mostrar el código QR
      const qrImg = document.createElement('img');
      qrImg.src = `data:image/png;base64,${formulaMasReciente.qr_code}`;
      formulaElement.appendChild(qrImg);

      // Agregar el elemento mi-formula al elemento formula-list en el DOM
      formulaList.appendChild(formulaElement);
      
    } else {
      console.error('Error al obtener las fórmulas:', result.error);
    }
  } catch (error) {
    console.error('Error al obtener las fórmulas:', error);
  }
};

window.onload = () => {
  displayFormulas();
};
